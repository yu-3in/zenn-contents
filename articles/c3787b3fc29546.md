---
title: "Next.jsã¨Prismaã‚’Cloudflareã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦æœˆ300ä¸‡ã®DBã‚¯ã‚¨ãƒªã«ç„¡æ–™ã§è€ãˆã‚‹"
emoji: "ğŸ’ª"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["prisma", "cloudflare", "nextjs", "postgresql"]
published: true
---

# ã¯ã˜ã‚ã«

Next.js ã‚’ Cloudflare ã«ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€å¿…ç„¶çš„ã« Edge Runtime ç’°å¢ƒã«ãªã‚Šã¾ã™ã€‚ã—ã‹ã—ã€Edge Runtime ç’°å¢ƒã§ã¯ã€Node.js Runtime ã¨ç•°ãªã‚Šã€Prisma ãŒãã®ã¾ã¾ä½¿ãˆã¾ã›ã‚“ã€‚

æœ€åˆã«æ€ã„æµ®ã‹ã¶è§£æ±ºç­–ã¯ [Prisma Accelerate](https://www.prisma.io/data-platform/accelerate) ã§ã™ã€‚Prisma Accelerate ã¯å…¬å¼ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã€æ¥ç¶šãƒ—ãƒ¼ãƒ«ã‚¤ãƒ³ã‚°ã‚„ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã‚’å‚™ãˆã¦ãŠã‚Šã€Edge Runtime ã§ã‚‚ Prisma ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
ã—ã‹ã—ã€**ç„¡æ–™ãƒ—ãƒ©ãƒ³ã ã¨æœˆã« 6 ä¸‡ã‚¯ã‚¨ãƒªã®åˆ¶é™**ãŒã‚ã‚Šã€æœ¬ç•ªé‹ç”¨ã«ã¯ä¸å®‰ãŒæ®‹ã‚Šã¾ã™ã€‚

ãã“ã§ã€ä»Šå›ã¯ Prisma Accelerate ã‚’è‡ªå‰ã§ Cloudflare Workers ä¸Šã«æ§‹ç¯‰ã—ã€æœ¬ç•ªé‹ç”¨ã«è€ãˆã†ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç„¡æ–™ã§é–‹ç™ºã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚ã“ã®æ–¹æ³•ãªã‚‰ã€**ç„¡æ–™ãƒ—ãƒ©ãƒ³ã§ã‚‚ æœˆã« 300 ä¸‡ã‚¯ã‚¨ãƒªã«è€ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™**ã€‚

ãªãŠã€å®Ÿè£…ã«ã¤ã„ã¦ã¯å¾Œè¿°ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®é–‹ç™ºè€…ã®[ã“ã¡ã‚‰ã®è¨˜äº‹](https://next-blog.croud.jp/contents/5f33241c-d6b2-4e8b-8b0a-f8d369729ce0)ä¸¦ã³ã«[ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰](https://www.npmjs.com/package/prisma-accelerate-local)ã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚

# prisma-accelerate-local

è‡ªå‰ã§ Prisma Accelerate ã‚’æ§‹ç¯‰ã™ã‚‹ã«ã¯ã€ [prisma-accelerate-local](https://github.com/node-libraries/prisma-accelerate-local) ã¨ã„ã†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
æœ¬æ¥ã¯ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒç”¨ã§ã™ãŒã€ã“ã‚Œã‚’ Cloudflare Workers ä¸Šã§å‹•ã‹ã™ã“ã¨ã§ã€Prisma Accelerate ã®ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãŒå¯èƒ½ã§ã™ã€‚

# Cloudflare Workers ã‚’æº–å‚™ã™ã‚‹

ã¾ãšã€Cloudflare Workers ã®é–‹ç™ºç’°å¢ƒã‚’æº–å‚™ã—ã¾ã™ã€‚ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ clone ã—ã¦ã€README.md ã«å¾“ã£ã¦é€²ã‚ã‚‹ã ã‘ã§ç°¡å˜ã«æ§‹ç¯‰ãŒã§ãã¾ã™ã€‚

https://github.com/yu-3in/prisma-accelerate-pg-workers

ã¾ãŸã€prisma-accelerate-local ã®é–‹ç™ºè€…æ§˜ã®ã‚µãƒ³ãƒ—ãƒ«ãƒªãƒã‚¸ãƒˆãƒªã‚‚å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

https://github.com/SoraKumo001/prisma-accelerate-workers

ä»¥ä¸‹ã®å†…å®¹ã¯ã€ä¸Šè¨˜ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ 0 ã‹ã‚‰æ§‹ç¯‰ã™ã‚‹æ‰‹é †ã§ã™ã€‚

## Cloudflare Workers ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

ã¾ãšåˆã‚ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚[Cloudflare Wrangler](https://developers.cloudflare.com/workers/wrangler/) ã‚’ä½¿ã£ã¦ã€CLI ã‹ã‚‰ä½œæˆã—ã¾ã™ã€‚

```bash
npx wrangler init prisma-accelerate-pg-workers
```

å…¨ã¦ã®è³ªå•ã«å¯¾ã—ã¦`y`ã¾ãŸã¯`yes` ã§å¤§ä¸ˆå¤«ã§ã™ã€‚
é€”ä¸­ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¤ãƒ—ã®é¸æŠè‚¢ãŒå‡ºã¦ããŸã‚‰ã€ `"Hello World" Worker` ã‚’é¸æŠã—ã¾ã™ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§é¸æŠã§ãã¾ã™ï¼‰ã€‚
æœ€å¾Œã®è³ªå•ã« `yes`ã¨å›ç­”ã™ã‚‹ã¨ã€Cloudflare Workers ã«è‡ªå‹•ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚

```
What type of application do you want to create?
â€Šâ€Šâ— "Hello World" Worker
â€Šâ€Šâ—‹ "Hello World" Worker (Python)
â€Šâ€Šâ—‹ "Hello World" Durable Object
â€Šâ€Šâ—‹ Website or web app
â€Šâ€Šâ—‹ Example router & proxy Worker
â€Šâ€Šâ—‹ Scheduled Worker (Cron Trigger)
â€Šâ€Šâ—‹ Queue consumer & producer Worker
â€Šâ€Šâ—‹ API starter (OpenAPI compliant)
â€Šâ€Šâ—‹ Worker built from a template hosted in a git repository
```

## ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

prisma-accelerate-local ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ãã®ä»– prisma é–¢é€£ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
ãªãŠã€ä»Šå›ã¯ PostgreSQL ã‚’ä½¿ç”¨ã™ã‚‹æƒ³å®šã§é€²ã‚ã¾ã™ã€‚

```bash
npm install @prisma/client prisma-accelerate-local @prisma/adapter-pg @prisma/adapter-pg-worker @prisma/pg-worker
```

## `.dev.vars` ãƒ•ã‚¡ã‚¤ãƒ«ã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š

ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« `.dev.vars` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¾ã™ã€‚
`xxx`ã«ã¯ä»»æ„ã®ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã‚’è¨­å®šã—ã¦ä¸‹ã•ã„ã€‚ã“ã®å€¤ã¯å¾Œã« `API_KEY` ã®ç”Ÿæˆã®ç¨®ã¨ã—ã¦ä½¿ã„ã¾ã™ã€‚

```:.dev.vars
PRISMA_ACCELERATE_SECRET=xxx
```

ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã«ã‚‚åæ˜ ã™ã‚‹ãŸã‚ã«ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
å…¥åŠ›ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã®ã§ã€ä¸Šã¨åŒã˜å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚

```bash
npx wrangler secret put PRISMA_ACCELERATE_SECRET
```

## Cloudflare KV ã‚’ä½œæˆ

Cloudflare ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ç§»å‹•ã—ã¾ã™ã€‚
å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ `Workers & Pages` ã‚’é¸æŠã—ã€é…ä¸‹ã® `KV` ã‚’é¸æŠã—ã¾ã™ã€‚

ã“ã®ã‚ˆã†ãªç”»é¢ã«é·ç§»ã™ã‚‹ã®ã§ã€å³å´ã® `Create Namespace` ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
![Cloudflare KVã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢](https://storage.googleapis.com/zenn-user-upload/21eafe761175-20240601.png)

`Namespace Name` ã«ã¯è­˜åˆ¥ã—ã‚„ã™ã„åå‰ã‚’è¨­å®šã—ã¾ã™ã€‚ã“ã“ã§ã¯ã€`prisma-accelerate-pg-workers` ã¨ã—ã¾ã™ã€‚å…¥åŠ›ã—ãŸã‚‰ `Add` ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
ä½œæˆã•ã‚ŒãŸ KV ã® ID ã‚’æ§ãˆã¦ãŠãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/22c9497ddb36-20240601.png)

## `wrangler.toml` ã®è¨­å®š

ç¶šã„ã¦ã€`wrangler.toml` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¾ã™ã€‚
`wrangler.toml` ã§ã¯ Cloudflare Workers ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã«é–¢ã™ã‚‹è¨­å®šã‚’ã—ã¾ã™ã€‚
ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚ŒãŸè¨­å®šã‹ã‚‰ã€å¿…è¦ãªè¡Œã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã—ã¦ç·¨é›†ã—ã¾ã™ã€‚

`kv_namespaces` ã® id ã«ã¯å…ˆã»ã©ä½œæˆã—ãŸ KV ã® ID ã‚’è¨­å®šã—ã¾ã™ã€‚

```diff:wrangler.toml
#:schema node_modules/wrangler/config-schema.json
name = "prisma-accelerate-pg-workers"
main = "src/index.ts"
compatibility_date = "2024-05-29"
compatibility_flags = ["nodejs_compat"]
+ minify = true

# Automatically place your workloads in an optimal location to minimize latency.
# If you are running back-end logic in a Worker, running it closer to your back-end infrastructure
# rather than the end user may result in better performance.
# Docs: https://developers.cloudflare.com/workers/configuration/smart-placement/#smart-placement
+ [placement]
+ mode = "smart"

...

# Bind a KV Namespace. Use KV as persistent storage for small key-value pairs.
# Docs: https://developers.cloudflare.com/workers/wrangler/configuration/#kv-namespaces
+ [[kv_namespaces]]
+ binding = "KV"
+ id = "xxxxxx"

...
```

## å‹å®šç¾©

ã¾ãšã€Wrangler ã‚’ä½¿ã£ã¦ã€ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€ãŸã‚ã®å‹ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚

```bash
npm run cf-typegen
```

`worker-configuration.d.ts` ã«å‹ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

```ts:worker-configuration.d.ts
interface Env {
  KV: KVNamespace;
  PRISMA_ACCELERATE_SECRET: string;
}
```

ã¤ã¥ã„ã¦ `types` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€prisma ã¨ wasm ã«é–¢ã™ã‚‹å‹ã‚’å®šç¾©ã—ã¾ã™ã€‚

```ts:types/prisma-edge.d.ts
declare module '@prisma/client/runtime/wasm.js' {
  export * from '@prisma/client/runtime/library';
}
```

```ts:types/wasm.d.ts
declare module '*.wasm' {
  const content: any;
  export default content;
}
```

## polyfill ã®è¿½åŠ 

```ts:polyfills/util.ts
export * from 'node:util';
```

## å®Ÿè£…

æœ€å¾Œã«ã€`src/index.ts` ã« Prisma Accelerate ç›¸å½“ã®å‡¦ç†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```ts:src/index.ts
import { Pool } from '@prisma/pg-worker';
import { PrismaPg } from '@prisma/adapter-pg-worker';
import WASM from '@prisma/client/runtime/query_engine_bg.postgresql.wasm';
import { PrismaAccelerate, PrismaAccelerateConfig, ResultError } from 'prisma-accelerate-local/lib';
import { getPrismaClient } from '@prisma/client/runtime/wasm.js';

const getAdapter = (datasourceUrl: string) => {
  const url = new URL(datasourceUrl);
  const schema = url.searchParams.get('schema') ?? undefined;
  const pool = new Pool({
    connectionString: url.toString() ?? undefined,
  });
  return new PrismaPg(pool, { schema });
};

let prismaAccelerate: PrismaAccelerate;

const getPrismaAccelerate = async ({
  secret,
  onRequestSchema,
  onChangeSchema,
}: {
  secret: string;
  onRequestSchema: PrismaAccelerateConfig['onRequestSchema'];
  onChangeSchema: PrismaAccelerateConfig['onChangeSchema'];
}) => {
  if (prismaAccelerate) {
    return prismaAccelerate;
  }
  prismaAccelerate = new PrismaAccelerate({
    singleInstance: true,
    secret,
    adapter: getAdapter,
    getRuntime: () => require('@prisma/client/runtime/query_engine_bg.postgresql.js'),
    getQueryEngineWasmModule: async () => WASM,
    getPrismaClient,
    onRequestSchema,
    onChangeSchema,
  });
  return prismaAccelerate;
};

const createResponse = async (result: Promise<unknown>) => {
  try {
    const response = await result;
    return new Response(JSON.stringify(response), {
      headers: { 'content-type': 'application/json' },
    });
  } catch (e) {
    if (e instanceof ResultError) {
      console.error(e.value);
      return new Response(JSON.stringify(e.value), {
        status: e.code,
        headers: { 'content-type': 'application/json' },
      });
    }
    return new Response(JSON.stringify(e), {
      status: 500,
      headers: { 'content-type': 'application/json' },
    });
  }
};

export default {
  async fetch(request: Request, env: Env): Promise<Response> {
    const prismaAccelerate = await getPrismaAccelerate({
      secret: env.PRISMA_ACCELERATE_SECRET,
      onRequestSchema: ({ engineVersion, hash, datasourceUrl }) => env.KV.get(`schema-${engineVersion}:${hash}:${datasourceUrl}`),
      onChangeSchema: ({ inlineSchema, engineVersion, hash, datasourceUrl }) =>
        env.KV.put(`schema-${engineVersion}:${hash}:${datasourceUrl}`, inlineSchema, { expirationTtl: 60 * 60 * 24 * 7 }),
    });

    const url = new URL(request.url);
    const paths = url.pathname.split('/');
    const command = paths[3];
    const headers = Object.fromEntries(request.headers.entries());

    if (request.method === 'POST') {
      const body = await request.text();
      if (command === 'graphql') {
        return createResponse(prismaAccelerate.query({ body, hash: paths[2], headers }));
      }
      if (command === 'transaction') {
        return createResponse(prismaAccelerate.startTransaction({ body, hash: paths[2], headers, version: paths[1] }));
      }
      if (command === 'itx') {
        const id = paths[4];
        const subCommand = paths[5];
        if (subCommand === 'commit') {
          return createResponse(prismaAccelerate.commitTransaction({ id, hash: paths[2], headers }));
        }
        if (subCommand === 'rollback') {
          return createResponse(prismaAccelerate.rollbackTransaction({ id, hash: paths[2], headers }));
        }
      }
    } else if (request.method === 'PUT' && command === 'schema') {
      const body = await request.text();
      return createResponse(prismaAccelerate.updateSchema({ body, hash: paths[2], headers }));
    }

    return new Response('Not Found', { status: 404 });
  },
};
```

## ãƒ‡ãƒ—ãƒ­ã‚¤

ã“ã“ã¾ã§å®Ÿè£…ã§ããŸã‚‰ã€Cloudflare Workers ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

```bash
npm run deploy
```

# Next.js å´ã®ä¿®æ­£

Next.js ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯æ¬¡ã® 2 ç‚¹ã«ã¤ã„ã¦è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

1. Prisma ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ edge ç”¨ã«å¤‰æ›´
2. `DATABASE_URL` ã‚’ Prisma Accelerate ç”¨ã«ä¿®æ­£

ãã‚Œãã‚Œé †ã«è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

## 1. Prisma ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ edge ç”¨ã«å¤‰æ›´

ã¾ãšã€Prisma ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ edge ç”¨ã«å¤‰æ›´ã—ã¾ã™ã€‚
å…·ä½“çš„ã«ã¯ã€ `PrismaClient` ã® import å…ˆã‚’ `@prisma/client`ã‹ã‚‰ `@prisma/client/edge`ã«å¤‰æ›´ã—ã¾ã™ã€‚
ã¾ãŸã€PrismaClient ã‚’ä½œæˆã™ã‚‹éš›ã« `withAccelerate` ã‚’å‘¼ã³å‡ºã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

```ts
import { PrismaClient } from "@prisma/client/edge";
import { withAccelerate } from "@prisma/extension-accelerate";

const prismaClientSingleton = () => {
  return new PrismaClient().$extends(withAccelerate());
};

declare const globalThis: {
  prismaGlobal: ReturnType<typeof prismaClientSingleton>;
} & typeof global;

const prisma = globalThis.prismaGlobal ?? prismaClientSingleton();

export default prisma;

if (process.env.NODE_ENV !== "production") globalThis.prismaGlobal = prisma;
```

## 2. `DATABASE_URL` ã‚’ Prisma Accelerate ç”¨ã«ä¿®æ­£

æ¬¡ã«ã€ç’°å¢ƒå¤‰æ•°ã® `DATABASE_URL` ã‚’ Cloudflare Workers ã®ã‚‚ã®ã«è¨­å®šã—ã¾ã™ã€‚

### `API_KEY`ã‚’ç”Ÿæˆ

ã¾ãšåˆã‚ã«æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

`--secret` ã«ã¯ã€ `.dev.vars` ã§æŒ‡å®šã—ãŸ `PRISMA_ACCELERATE_SECRET` ã¨åŒã˜å€¤ã‚’æŒ‡å®šã—ã¾ã™ã€‚
`--make` ã«ã¯ã€supabase ãªã©ã® `DATABASE_URL` ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```
npx prisma-accelerate-local --secret enter_your_secret --make postgres://xxx
```

å®Ÿè¡Œã™ã‚‹ã¨ã€`ey`ã‹ã‚‰å§‹ã¾ã‚‹ `API_KEY` ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã®ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãŠãã¾ã™ã€‚

### ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

`.env.local` ãªã©ã«ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

```bash
DATABASE_URL=prisma://xxxx.workers.dev?api_key=your_api_key
```

æ³¨æ„ç‚¹ã¨ã—ã¦ã€URL ã®ã‚¹ã‚­ãƒ¼ãƒãŒ `prisma` ã§ã‚ã‚‹ã“ã¨ã€ãƒ›ã‚¹ãƒˆãŒ `xxxx.workers.dev` ã§ã‚ã‚‹ã“ã¨ã€ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã« `api_key` ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

# ãŠã‚ã‚Šã«

Cloudflare Workers ä¸Šã«è‡ªå‰ã§ Prisma Accelerate ã‚’æ§‹ç¯‰ã—ã€Next.js ã¨ Prisma ã‚’ç„¡æ–™ã§æœ¬ç•ªé‹ç”¨ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
Edge Runtime ç’°å¢ƒã§ã®åˆ¶ç´„ã‚’å…‹æœã—ã€é«˜ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç¶­æŒã—ãªãŒã‚‰ã‚‚ã‚³ã‚¹ãƒˆã‚’æŠ‘ãˆã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ç‰¹ã«ã€æœˆé–“ 300 ä¸‡ã‚¢ã‚¯ã‚»ã‚¹ã«ã‚‚è€ãˆã†ã‚‹å …ç‰¢ãªã‚µãƒ¼ãƒ“ã‚¹ã‚’æ§‹ç¯‰ã§ãã‚‹ç‚¹ãŒå¤§ããªé­…åŠ›ã§ã™ã€‚
ãœã²ã€ã“ã®æ–¹æ³•ã‚’è©¦ã—ã¦ã¿ã¦ã€çš†ã•ã‚“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å½¹ç«‹ã¦ã¦ãã ã•ã„ã€‚

# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### PrismaClientValidationError: Invalid client engine type, please use `library` or `binary`

prisma generate ã®å¼•æ•°ã« `--no-engine` ã‚’ã¤ã‘ã¦å†åº¦å®Ÿè¡Œã—ã¦ä¸‹ã•ã„ã€‚

https://www.prisma.io/docs/orm/reference/prisma-cli-reference#options-1

### `Unauthorized, check your connection string: {"type":"UnknownJsonError","body":{"Unauthorized":{"reason":"InvalidKey"}}}`

`API_KEY`ã‚’æ­£ã—ãè¨­å®šã§ãã¦ã„ã¾ã›ã‚“ã€‚ [API_KEY ã‚’ç”Ÿæˆ](#api_keyã‚’ç”Ÿæˆ) ã®æ‰‹é †ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

# å‚è€ƒ

https://www.prisma.io/docs/orm/prisma-client/deployment/edge/deploy-to-cloudflare

https://next-blog.croud.jp/contents/5f33241c-d6b2-4e8b-8b0a-f8d369729ce0
