---
title: "Next.js Ã— Convex Ã— Clerkã§èªè¨¼ä»˜ããƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã‚¢ãƒ—ãƒªã‚’ãƒ©ã‚¯ã«é–‹ç™ºã™ã‚‹"
emoji: "ğŸ”¨"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextjs", "convex", "clerk"]
published: true
---

# ã¯ã˜ã‚ã«

ã“ã®è¨˜äº‹ã§ã¯ã€Next.js Ã— Convex Ã— Clerk ã§ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã‚¢ãƒ—ãƒªã‚’ä½œã‚‹æ–¹æ³•ã‚’ãƒãƒ³ã‚ºã‚ªãƒ³å½¢å¼ã§ç´¹ä»‹ã—ã¾ã™ã€‚
Convex ã¨ Clerk ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€èªè¨¼ä»˜ãã®ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã‚¢ãƒ—ãƒªã‚’çˆ†é€Ÿã§é–‹ç™ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

å®Œæˆç‰©ã¯ã€ä»¥ä¸‹ã® GitHub ãƒªãƒã‚¸ãƒˆãƒªã§å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚

https://github.com/yu-3in/nextjs-convex-clerk-sample

## Convex ã¨ã¯

Convex ã¯ã€Firebase ã®ã‚ˆã†ãªãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚„ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãªã©ã®æ©Ÿèƒ½ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

https://convex.dev/

Firebase ã¨ã®é•ã„ã¯ã€ä»¥ä¸‹ã®è¨˜äº‹ã§è©³ã—ãè§£èª¬ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://stack.convex.dev/convex-vs-firebase

## Clerk ã¨ã¯

Clerk ã¯ã€èªè¨¼ãƒ»èªå¯ã‚’æä¾›ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚Clerk ã¨ Convex ã‚’ä½µç”¨ã™ã‚‹ã“ã¨ã§ã€èªè¨¼ãƒ»èªå¯ã®å®Ÿè£…ã‚’éå¸¸ã«ç°¡å˜ã«è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

https://clerk.com/

Next.js ã§ã®èªè¨¼ã¨ã„ãˆã°ã€NextAuth ãŒæ€ã„æµ®ã‹ã³ã¾ã™ã€‚NextAuth ã§ã¯ middleware ã‚’è¨˜è¿°ã—ãŸã‚Šã€èªè¨¼ã®ãŸã‚ã® API ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚‚ã‚¼ãƒ­ã‹ã‚‰ä½œã‚‰ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚ã“ã‚Œã‚‰ã¯èªè¨¼ã«ã¤ã„ã¦ç†è§£ãŒãªã‘ã‚Œã°ã¤ã¾ã¥ã„ã¦ã—ã¾ã„ã¾ã™ã—ã€å®Ÿè£…ã«ã‚‚æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚
ã—ã‹ã—ã€Clerk ã§ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚Clerk ã¯èªè¨¼ã«ã¾ã¤ã‚ã‚‹ Hooks ã‚„ UI ã‚’æä¾›ã—ã¦ãã‚Œã‚‹ãŸã‚ã€èªè¨¼ã«ã¤ã„ã¦ç†è§£ãŒãªãã¦ã‚‚ç°¡å˜ã«èªè¨¼æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- Next.js v14.1.0 (App router)
- Convex
- Clerk
- (Tailwind CSS)

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

## Next.js ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

ã¾ãšåˆã‚ã« Next.js ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚é€”ä¸­ã®é¸æŠè‚¢ã¯å…¨ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã§å¤§ä¸ˆå¤«ã§ã™ã€‚

```bash
$ npx create-next-app@14.1.0 nextjs-convex-clerk-sample
```

ä½œæˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ç§»å‹•ã—ã¾ã™ã€‚

```bash
$ cd nextjs-convex-clerk-sample
```

é–‹ç™ºã‚µãƒ¼ãƒã‚’èµ·å‹•ã—ã¾ã™ã€‚

```bash
$ npm run dev
```

## Convex ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

ã¾ãšã€[convex.dev](https://convex.dev/) ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€GitHub ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãŠãã¾ã™ã€‚

![Convexã®ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸](https://storage.googleapis.com/zenn-user-upload/a69a495e0441-20240121.png)

ç¶šã„ã¦ã€Convex ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚æ–°ã—ã„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ã„ã¦ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ï¼ˆ `npm run dev` ã¯çµ‚äº†ã•ã›ãªã„ã§ãã ã•ã„ï¼‰

```bash
$ npm install convex
```

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆãƒ»é¸æŠã¨é–‹ç™ºç”¨ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãŒèµ·å‹•ã—ã¾ã™ã€‚
GitHub ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯ã€ãƒ­ã‚°ã‚¤ãƒ³ã‚’æ±‚ã‚ã‚‰ã‚Œã‚‹ã®ã§ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚

```bash
$ npx convex dev
```

é¸æŠè‚¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã“ã“ã§ã¯ `a new project` ã‚’é¸æŠã—ã¾ã™ã€‚æ–°ã—ããƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒä½œæˆã•ã‚Œã‚‹ã®ã§ã€ãã®åå‰ã‚’å…¥åŠ›ã—ã¾ã™ã€‚

```bash
$ npx convex dev
? What would you like to configure? a new project
? Project name: (nextjs-convex-clerk-sample)
```

ä½œæˆãŒå®Œäº†ã™ã‚‹ã¨ã€ `.env.local` ãŒä½œæˆã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€Convex ã®é–‹ç™ºç”¨ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒã® URL ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

```dot:.env.local
# Deployment used by `npx convex dev`
CONVEX_DEPLOYMENT=dev:xxx # team: your-name, project: nextjs-convex-clerk-sample

NEXT_PUBLIC_CONVEX_URL=https://xxx.convex.cloud
```

:::message
ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒã¨ã—ã¦ã®æ©Ÿèƒ½ã‚‚å…¼ã­ã¦ã„ã‚‹ãŸã‚ã€é–‹ç™ºä¸­ã¯èµ·å‹•ã—ãŸã¾ã¾ã«ã—ã¦ãã ã•ã„ã€‚ãªãŠã€çµ‚äº†ã™ã‚‹éš›ã¯ `Ctrl + C` ã§çµ‚äº†ã§ãã¾ã™ã€‚
:::

## Clerk ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

ç¶šã„ã¦ Clerk ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚
ã¾ãšã€[clerk.com](https://clerk.com/) ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãŠãã¾ã™ã€‚

ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ã«é·ç§»ã—ã¾ã™ã€‚ã“ã“ã§ã€`Add application` ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![Clerkã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢](https://storage.googleapis.com/zenn-user-upload/81e42a6716f0-20240121.png)

ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€ `Application name` ã«ä»»æ„ã®åå‰ã‚’ï¼ˆã“ã“ã§ã¯ `nextjs-convex-clerk-sample`ï¼‰ã€Google ãƒ­ã‚°ã‚¤ãƒ³ã®ã¿ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ã€å³ä¸‹ã® `Create application`ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![Clerkã®æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹](https://storage.googleapis.com/zenn-user-upload/8b0c6b762efd-20240121.png)

ä½œæˆãŒå®Œäº†ã™ã‚‹ã¨ç’°å¢ƒå¤‰æ•°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€ãã‚Œã‚‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ `.env.local` ã«è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚

```dot:.env.local
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=xxx
CLERK_SECRET_KEY=sk_test_xxx
```

ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«æˆ»ã‚Šã€Clerk ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
$ npm install @clerk/nextjs
```

## Convex ã¨ Clerk ã‚’é€£æºã™ã‚‹

æœ€å¾Œã«ã€Convex ã¨ Clerk ã‚’é€£æºã—ã¾ã™ã€‚
ã“ã¡ã‚‰ã®å…¬å¼ã®è¨˜äº‹ã‚‚å‚è€ƒã«ãªã‚Šã¾ã™ã€‚

https://docs.convex.dev/auth/clerk

### JWT Template ã®ä½œæˆ

å†åº¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ŒJWT Templateã€ã‚’é¸æŠã—ã¦ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸é·ç§»ã—ã¾ã™ã€‚
`New Template`ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€è¡¨ç¤ºã•ã‚Œã‚‹é …ç›®ã‹ã‚‰ `Convex`ã‚’é¸æŠã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/13fd5eecda64-20240121.png)

![](https://storage.googleapis.com/zenn-user-upload/d895c7138005-20240121.png)

JWT Template ã®è¨­å®šç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚è¨­å®šé …ç›®ã¯ç‰¹ã«å¤‰æ›´ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ãŸã ã—ã€ã€ŒIssuerã€ã®å€¤ã¯ã“ã®å¾Œã®è¨­å®šã§ä½¿ç”¨ã™ã‚‹ã®ã§ã€ã‚³ãƒ”ãƒ¼ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚

ã‚³ãƒ”ãƒ¼ã—ãŸã‚‰ã€å³ä¸‹ã® `Apply Changes`ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/44978574d9c1-20240121.png)

### `convex/auth.config.js`ã‚’ä½œæˆã™ã‚‹

`convex/auth.config.js`ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€JWT Template ã®è¨­å®šã‚’è¨˜è¿°ã—ã¾ã™ã€‚
`https://your-issuer-url.clerk.accounts.dev/` ã«ã¯ã€å…ˆã»ã©ã‚³ãƒ”ãƒ¼ã—ãŸ Issuer ã®å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚

```js:convex/auth.config.js
export default {
  providers: [
    {
      domain: "https://your-issuer-url.clerk.accounts.dev/",
      applicationID: "convex",
    },
  ]
};
```

æœ€å¾Œã«å†åº¦ `npx convex dev` ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
$ npx convex dev
```

### convex-client-provider ã‚’ä½œæˆã™ã‚‹

`app`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨åŒéšå±¤ã«`providers`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚ç¶šã„ã¦ã€`providers`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«`convex-client-provider.ts`ã‚’ä½œæˆã—ã¾ã™ã€‚

```ts:providers/convex-client-provider.ts
"use client";
import { ReactNode } from "react";
import { ConvexProviderWithClerk } from "convex/react-clerk";
import { ClerkProvider, useAuth } from "@clerk/nextjs";
import { ConvexReactClient } from "convex/react";

const convex = new ConvexReactClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

export default function ConvexClientProvider({
  children,
}: {
  children: ReactNode;
}) {
  return (
    <ClerkProvider
      publishableKey={process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY!}
    >
      <ConvexProviderWithClerk useAuth={useAuth} client={convex}>
        {children}
      </ConvexProviderWithClerk>
    </ClerkProvider>
  );
}

```

`app/layout.tsx`ã«ç§»å‹•ã—ã€`ConvexClientProvider`ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```diff tsx:app/layout.tsx
import "./globals.css";
import type { Metadata } from "next";
import { Inter } from "next/font/google";
+ import ConvexClientProvider from "./ConvexClientProvider";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body className={inter.className}>
+         <ConvexClientProvider>{children}</ConvexClientProvider>
      </body>
    </html>
  );
}
```

ã“ã“ã¾ã§ã§ã€Next.js ã¨ Convexã€ Clerk ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯å®Œäº†ã§ã™ã€‚

# ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹

ã¾ãšã¯ã˜ã‚ã«ã€`app/page.tsx`ã‚’é–‹ãã¾ã™ã€‚
ä¸€æ—¦å…¨ã¦å‰Šé™¤ã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã¾ã™ã€‚ï¼ˆå†’é ­ã® `"use client";` ã‚’å¿˜ã‚Œãªã„ã§ãã ã•ã„ï¼ï¼‰

```tsx:app/page.tsx
"use client";

export default function Home() {
  return (
    <div className="h-screen flex items-center justify-center flex-col gap-y-4">
      <h1 className="text-xl font-semibold">ã‚ˆã†ã“ãï¼</h1>
      <div className="flex gap-4"></div>
    </div>
  );
}
```

ä½µã›ã¦ã€`app/globals.css`ã‚‚ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚tailwind ã¯ä½¿ã†ã®ã§ã€ãã®ã¾ã¾æ®‹ã—ã¦ãŠãã¾ã™ã€‚

```css:app/globals.css
@tailwind base;
@tailwind components;
@tailwind utilities;
```

## ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’è¨­ç½®ã™ã‚‹

æœ¬é¡Œã®ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚ã¨ã„ã£ã¦ã‚‚ä¸€ç¬ã§ã™ã€‚ `<SignInButton>`ã‚’è¿½åŠ ã™ã‚‹ã ã‘ã§ã™ï¼ğŸ‘€

```diff tsx:app/page.tsx
"use client";

+ import { SignInButton } from "@clerk/nextjs";

export default function Home() {
  return (
    <div className="h-screen flex items-center justify-center flex-col gap-y-4">
      <h1 className="text-xl font-semibold">ã‚ˆã†ã“ãï¼</h1>
      <div className="flex gap-4">
+        <SignInButton mode="modal">
+          <button className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
+            ãƒ­ã‚°ã‚¤ãƒ³
+          </button>
+        </SignInButton>
      </div>
    </div>
  );
}
```

http://localhost:3000 ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚
è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã€Œãƒ­ã‚°ã‚¤ãƒ³ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãƒ­ã‚°ã‚¤ãƒ³ç”¨ã® UI ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã€ Clerk ãŒã‚ã‚‰ã‹ã˜ã‚ç”¨æ„ã—ã¦ãã‚Œã¦ã„ã‚‹ã‚‚ã®ã§ã™ï¼

![](https://storage.googleapis.com/zenn-user-upload/087a6d8e2bde-20240121.png)

`Continue with Google`ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€Google ã®ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã“ã“ã§ Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ã€ãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã—ã¾ã™ã€‚

Clerk ãŒç”¨æ„ã—ã¦ãã‚Œã¦ã„ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ä»–ã«ã‚‚ãŸãã•ã‚“ã‚ã‚Šã¾ã™ã€‚ã“ã®ã‚ˆã†ã«ã€Clerk ã¨ãã‚Œã«å¯¾å¿œã—ã¦ã„ã‚‹ Convex ã‚’ä½¿ã†ã¨æœ€å°é™ã®ã‚³ãƒ¼ãƒ‰ã§ã‚¹ãƒãƒ¼ãƒˆãªèªè¨¼æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

https://clerk.com/docs/components/overview

## ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã™ã‚‹

ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã®è¨­ç½®ã‚‚ç°¡å˜ã§ã™ã€‚æ¬¡ã®ã‚ˆã†ã« `<SignOutButton>`ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```diff tsx:app/page.tsx
"use client";

+ import { SignInButton, SignOutButton } from "@clerk/nextjs";

export default function Home() {
  return (
    <div className="h-screen flex items-center justify-center flex-col gap-y-4">
      <h1 className="text-xl font-semibold">ã‚ˆã†ã“ãï¼</h1>
      <div className="flex gap-4">
        <SignInButton mode="modal">
          <button className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
            ãƒ­ã‚°ã‚¤ãƒ³
          </button>
        </SignInButton>
+        <SignOutButton>
+          <button className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
+            ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
+          </button>
+        </SignOutButton>
      </div>
    </div>
  );
}
```

ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã‚Œã°æˆåŠŸã§ã™ï¼ğŸ‰

![](https://storage.googleapis.com/zenn-user-upload/67785831f652-20240121.png)

## ãƒ¦ãƒ¼ã‚¶æƒ…å ±ã‚’å–å¾—ã™ã‚‹

ã“ã®ã¾ã¾ã ã¨ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ UI ã«åæ˜ ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚ãã“ã§ã€ãƒ¦ãƒ¼ã‚¶æƒ…å ±ã‚’å–å¾—ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

`app/page.tsx`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ç·¨é›†ã—ã¾ã™ã€‚

```diff tsx:app/page.tsx
"use client";

+ import { SignInButton, SignOutButton, useUser } from "@clerk/nextjs";
+ import { useConvexAuth } from "convex/react";

export default function Home() {
+  const { isAuthenticated, isLoading } = useConvexAuth();
+  const { user } = useUser();

+  if (isLoading) return <div>Loading...</div>;

  return (
    <div className="h-screen flex items-center justify-center flex-col gap-y-4">
      <h1 className="text-xl font-semibold">
+        ã‚ˆã†ã“ãï¼{isAuthenticated ? user?.fullName : "ã‚²ã‚¹ãƒˆ"}ã•ã‚“
      </h1>
      <div className="flex gap-4">
+        {!isAuthenticated ? (
          <SignInButton mode="modal">
            <button className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
              ãƒ­ã‚°ã‚¤ãƒ³
            </button>
          </SignInButton>
+        ) : (
          <SignOutButton>
            <button className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
              ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </button>
          </SignOutButton>
+        )}
      </div>
    </div>
  );
}
```

å†åº¦ http://localhost:3000 ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®åå‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/86eb82c8aac9-20240121.png)

ã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã€ï¼’ç‚¹è§£èª¬ã—ã¾ã™ã€‚

### 1. `useConvexAuth`

`useConvexAuth`ã¯ã€Convex ã®èªè¨¼ã‚¹ãƒ†ãƒ¼ãƒˆã‚’å–å¾—ã™ã‚‹ãƒ•ãƒƒã‚¯ã§ã™ã€‚

- `isAuthenticated`ï¼šãƒ¦ãƒ¼ã‚¶ãŒèªè¨¼æ¸ˆã¿ã‹ã©ã†ã‹ã‚’è¡¨ã™çœŸå½å€¤ã§ã™ã€‚
- `isLoading` ï¼šèªè¨¼ã‚¹ãƒ†ãƒ¼ãƒˆã®ãƒ•ã‚§ãƒƒãƒãŒå®Œäº†ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’è¡¨ã™çœŸå½å€¤ã§ã™ã€‚

https://docs.convex.dev/api/modules/react#functions

### 2. `useUser`

`useUser`ã¯ã€Clerk ã®ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãƒ•ãƒƒã‚¯ã§ã™ã€‚`user`ã®ä»–ã«`isSignedIn`ã‚„`isLoaded`ã‚’è¿”ã—ã¾ã™ã€‚

https://clerk.com/docs/references/react/use-user

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ã†ï¼ˆConvexï¼‰

## schema ã‚’å®šç¾©ã™ã‚‹

`convex/schema.ts`ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã“ã§ã¯ã€`messages`ã¨ã„ã†ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```ts:convex/schema.ts
import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

export default defineSchema({
  messages: defineTable({
    title: v.string(),
    content: v.optional(v.string()),
    userId: v.string(),
  }).index("by_user", ["userId"]),
});

```

å®šç¾©ã™ã‚‹ã¨ã€`npx convex dev`ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```bash
âœ” Schema validation complete.
```

ã“ã‚Œã«ã‚ˆã£ã¦ã€è‡ªå‹•ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

[dashboard.convex.dev](https://dashboard.convex.dev)ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€`nextjs-convex-clerk-sample`ã‚’é¸æŠã—ã¾ã—ã‚‡ã†ã€‚`messages`ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/18ba694476d2-20240121.png)

schema ã®ä½œæˆã«ã¤ã„ã¦ã€è©³ã—ãã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

https://docs.convex.dev/database/schemas

## API ã‚’ä½œæˆã™ã‚‹

ç¶šã„ã¦ã€`convex/messages.ts`ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã“ã§ã¯ã€`messages`ãƒ†ãƒ¼ãƒ–ãƒ«ã® CRUD API ã‚’ä½œæˆã—ã¾ã™ã€‚

### GET API ã‚’ä½œæˆã™ã‚‹

ã¾ãšã€GET API ã‚’ä½œæˆã—ã¾ã™ã€‚`getAll`ã¨ã„ã†åå‰ã§ä½œæˆã—ã¾ã™ã€‚

```ts:convex/messages.ts
import { query } from "./_generated/server";
import { v } from "convex/values";

export const getAll = query({
  handler: async (ctx) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) {
      throw new Error("UnAuthorized");
    }
    const userId = identity.subject;

    const messages = await ctx.db
      .query("messages")
      .withIndex("by_user", (q) => q.eq("userId", userId))
      .order("desc")
      .collect();

    return messages;
  },
});
```

ã„ãã¤ã‹è§£èª¬ã—ã¾ã™ã€‚

```ts
const identity = await ctx.auth.getUserIdentity();
if (!identity) {
  throw new Error("UnAuthorized");
}
const userId = identity.subject;
```

ã“ã“ã§ã¯èªè¨¼ã‚’è¡Œãªã£ã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯ã€`UnAuthorized`ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¾ã™ã€‚ã¾ãŸã€`identity.subject`ã¯ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ã® ID ã§ã™ã€‚

```ts
const messages = await ctx.db
  .query("messages")
  .withIndex("by_user", (q) => q.eq("userId", userId))
  .order("desc")
  .collect();
```

`ctx.db.query`ã§ã‚¯ã‚¨ãƒªã‚’ä½œæˆã—ã¾ã™ã€‚`withIndex`ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ã‚¯ã‚¨ãƒªã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒå‘ä¸Šã—ã¾ã™ã€‚

ä»–ã«ã‚‚æ§˜ã€…ãªã‚¯ã‚¨ãƒªãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚è©³ã—ãã¯ã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

https://docs.convex.dev/database/reading-data

### POST API ã‚’ä½œæˆã™ã‚‹

ç¶šã„ã¦ã€POST API ã‚’ä½œæˆã—ã¾ã™ã€‚`create`ã¨ã„ã†åå‰ã§ä½œæˆã—ã¾ã™ã€‚

```ts:convex/messages.ts
import { query, mutation } from "./_generated/server";
import { v } from "convex/values";

...

export const create = mutation({
  args: {
    title: v.string(),
    content: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) {
      throw new Error("UnAuthorized");
    }
    const userId = identity.subject;

    const message = await ctx.db.insert("messages", {
      title: args.title,
      content: args.content,
      userId,
    });

    return message;
  },
});
```

GET API ã¨åŒæ§˜ã«èªè¨¼ã‚’è¡Œãªã£ãŸã®ã¡ã«ã€ `ctx.db.insert`ã§ãƒ‡ãƒ¼ã‚¿ã‚’æŒ¿å…¥ã—ã¦ã„ã¾ã™ã€‚

```ts
args: {
  title: v.string(),
  content: v.optional(v.string()),
},
```

`args`ã«ã¯ã€API ã«æ¸¡ã™å¼•æ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚ã“ã“ã§ã¯ã€`title`ã¨`content`ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

`v.id` ã¯ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ã¨å‘¼ã°ã‚Œã‚‹ã‚‚ã®ã§ã™ã€‚æ¡ä»¶ã«åˆè‡´ã—ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¾ã™ã€‚`v.id("messages")`ã¯ã€`messages`ãƒ†ãƒ¼ãƒ–ãƒ«ã® ID ã§ã‚ã‚‹ã“ã¨ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚
å‘¼ã³å‡ºã—å´ã«å¯¾ã—ã¦ã‚‚å‹æƒ…å ±ãŒæä¾›ã•ã‚Œã‚‹ãŸã‚ã€å‹å®‰å…¨ã«ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

https://docs.convex.dev/functions/args-validation

:::details ã“ã“ã¾ã§ã® `convex/messages.ts` ã®ã‚³ãƒ¼ãƒ‰ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```ts:convex/messages.ts
import { mutation, query } from "./_generated/server";
import { v } from "convex/values";

export const getAll = query({
  handler: async (ctx) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) {
      throw new Error("UnAuthorized");
    }
    const userId = identity.subject;

    const messages = await ctx.db
      .query("messages")
      .withIndex("by_user", (q) => q.eq("userId", userId))
      .order("desc")
      .collect();

    return messages;
  },
});

export const create = mutation({
  args: {
    title: v.string(),
    content: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) {
      throw new Error("UnAuthorized");
    }
    const userId = identity.subject;

    const message = await ctx.db.insert("messages", {
      title: args.title,
      content: args.content,
      userId,
    });

    return message;
  },
});
```

:::

## API ã‚’å‘¼ã³å‡ºã™

æœ€å¾Œã«ã€å…ˆã»ã©ä½œæˆã—ãŸ API ã‚’å‘¼ã³å‡ºã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ä»Šå›ã¯æ–°ã—ã `/messages`ã¨ã„ã†ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™ã€‚`app/messages/layout.tsx`ã¨`app/messages/page.tsx`ã‚’ä½œæˆã—ã¾ã™ã€‚

```tsx:app/messages/layout.tsx
"use client";

import { useConvexAuth } from "convex/react";
import { redirect } from "next/navigation";

const MessagesLayout = ({ children }: { children: React.ReactNode }) => {
  const { isAuthenticated, isLoading } = useConvexAuth();

  if (isLoading) {
    return <div>Loading...</div>;
  }

  if (!isAuthenticated) {
    return redirect("/");
  }

  return <>{children}</>;
};

export default MessagesLayout;
```

```tsx:app/messages/page.tsx
"use client";

import { api } from "@/convex/_generated/api";
import { useMutation, useQuery } from "convex/react";
import { useState } from "react";

const Messages = () => {
  const messages = useQuery(api.messages.getAll);
  const create = useMutation(api.messages.create);

  const [title, setTitle] = useState("");
  const [content, setContent] = useState("");

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();

    await create({ title, content });

    setTitle("");
    setContent("");
  };

  return (
    <div className="h-screen flex items-center justify-center flex-col gap-y-4">
      <h1 className="text-2xl font-bold mb-4">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§</h1>
      <ul className="list-none gap-y-4 flex flex-col">
        {messages?.map((message, index) => (
          <li
            key={message._id}
            className="flex gap-2 flex-col border border-gray-300 px-4 py-2 rounded-lg"
          >
            <div className="font-bold">{message.title}</div>
            <div className="ml-4">{message.content}</div>
          </li>
        ))}
      </ul>

      <form
        onSubmit={handleSubmit}
        className="w-full max-w-xl border-t border-gray-300 mt-8 pt-12"
      >
        <h2 className="text-xl font-bold text-center mb-8">
          ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹
        </h2>
        <div className="flex items-center justify-center flex-col -mx-3 mb-6 gap-4">
          <div className="w-full md:w-1/2 px-3 mb-6 md:mb-0">
            <label
              className="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
              htmlFor="title"
            >
              ã‚¿ã‚¤ãƒˆãƒ«
            </label>
            <input
              className="appearance-none block w-full bg-gray-200 text-gray-700 border rounded py-3 px-4 mb-3 leading-tight focus:outline-none focus:bg-white"
              id="title"
              type="text"
              onChange={(e) => setTitle(e.target.value)}
            />
          </div>
          <div className="w-full md:w-1/2 px-3">
            <label
              className="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
              htmlFor="content"
            >
              å†…å®¹
            </label>
            <textarea
              className="appearance-none block w-full bg-gray-200 text-gray-700 border border-gray-200 rounded py-3 px-4 leading-tight focus:outline-none focus:bg-white focus:border-gray-500"
              id="content"
              onChange={(e) => setContent(e.target.value)}
            />
          </div>
          <button className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
            ä½œæˆã™ã‚‹
          </button>
        </div>
      </form>
    </div>
  );
};

export default Messages;
```

ã‚³ãƒ¼ãƒ‰ã‚’è§£èª¬ã—ã¾ã™ã€‚

```tsx
const messages = useQuery(api.messages.getAll);
```

`useQuery`ã¨`useMutation`ã¯ã€API ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®ãƒ•ãƒƒã‚¯ã§ã™ã€‚`useQuery`ã¯ã€API ã‚’å‘¼ã³å‡ºã—ã¦ãã®çµæœã‚’å–å¾—ã—ã¾ã™ã€‚

```tsx
const create = useMutation(api.messages.create);
...
await create({ title, content });
```

`useMutation`ã¯ã€API ã‚’å‘¼ã³å‡ºã—ã¦ãã®çµæœã‚’å–å¾—ã—ã¾ã™ã€‚`create`ã¯ã€`api.messages.create`ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®é–¢æ•°ã§ã™ã€‚`create`ã«å¼•æ•°ã‚’æ¸¡ã™ã“ã¨ã§ã€API ã«å¼•æ•°ã‚’æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

http://localhost:3000/messages ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/0c30af021132-20240121.png)

ãƒ•ã‚©ãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã¾ã™ ğŸ‰

![](https://storage.googleapis.com/zenn-user-upload/8eb8061393d3-20240121.png)

# ãŠã‚ã‚Šã«

ä»Šå›ã¯ã€Next.js Ã— Convex Ã— Clerk ã§ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã‚¢ãƒ—ãƒªã‚’ãƒ©ã‚¯ã«é–‹ç™ºã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
Convex ã¨ Clerk ã‚’ä½µç”¨ã™ã‚‹ã“ã¨ã§ã€èªè¨¼ä»˜ãã®ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã‚¢ãƒ—ãƒªã‚’éå¸¸ã«ç°¡å˜ã«å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä»Šå›ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ã€ä»¥ä¸‹ã® GitHub ãƒªãƒã‚¸ãƒˆãƒªã§å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚

https://github.com/yu-3in/nextjs-convex-clerk-sample

æœ€å¾Œã¾ã§ãŠèª­ã¿ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼
